<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matcha Speed Test</title>

<style>
:root {
  --bg1:#081c15;
  --bg2:#1b4332;
  --card:#163a2b;
  --accent:#95d5b2;
  --text:#e9f5ef;
}

*{box-sizing:border-box}

body{
  margin:0;
  height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg1));
  font-family:system-ui;
  color:var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  width:360px;
  background:var(--card);
  border-radius:22px;
  padding:20px;
  box-shadow:0 0 30px rgba(149,213,178,.35);
  text-align:center;
}

h1{
  margin:5px 0 15px;
  letter-spacing:3px;
}

.stats{
  display:flex;
  justify-content:space-between;
  margin-bottom:15px;
}

.stat{
  font-size:13px;
}
.stat span{
  display:block;
  font-size:22px;
  font-weight:700;
  color:var(--accent);
}

.gauge{
  position:relative;
  width:260px;
  height:130px;
  margin:15px auto;
  border-radius:260px 260px 0 0;
  background:linear-gradient(90deg,#2d6a4f,#b7e4c7);
  overflow:hidden;
}

.needle{
  position:absolute;
  bottom:0;
  left:50%;
  width:4px;
  height:115px;
  background:#fff;
  transform-origin:bottom;
  transform:rotate(-90deg);
  transition:transform .2s linear;
}

.speed{
  font-size:28px;
  font-weight:700;
  margin:10px 0;
}

.progress{
  height:4px;
  background:rgba(255,255,255,.2);
  border-radius:4px;
  overflow:hidden;
}
.bar{
  width:0%;
  height:100%;
  background:var(--accent);
  transition:width .2s linear;
}

button{
  margin-top:14px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:16px;
  background:var(--accent);
  font-weight:700;
  cursor:pointer;
}

button:disabled{
  opacity:.6;
}

.miku{
  margin-top:12px;
}
.miku img{
  width:80px;
  filter:drop-shadow(0 0 10px #95d5b2);
}
</style>
</head>

<body>
<div class="card">
  <h1>SPEED TEST</h1>

  <div class="stats">
    <div class="stat">PING<span id="ping">-</span></div>
    <div class="stat">DOWNLOAD<span id="down">0 Mbps</span></div>
    <div class="stat">UPLOAD<span id="up">0 Mbps</span></div>
  </div>

  <div class="gauge">
    <div class="needle" id="needle"></div>
  </div>

  <div class="progress"><div class="bar" id="bar"></div></div>

  <div class="speed" id="speed">0 Mbps</div>

  <button id="btn" onclick="startTest()">START TEST</button>

  <div class="miku">
    <img src="miku.png">
  </div>
</div>

<script>
const maxGauge = 1000;

function rotateNeedle(mbps){
  const angle = Math.min(mbps / maxGauge * 180 - 90, 90);
  document.getElementById("needle").style.transform =
    `rotate(${angle}deg)`;
}

async function pingTest(){
  const t0 = performance.now();
  await fetch("https://www.cloudflare.com/cdn-cgi/trace",{cache:"no-store"});
  return Math.round(performance.now()-t0);
}

async function downloadTest(){
  const url="https://speed.cloudflare.com/__down?bytes=25000000";
  let start=performance.now();
  let res=await fetch(url,{cache:"no-store"});
  let reader=res.body.getReader();
  let received=0;

  while(true){
    const {done,value}=await reader.read();
    if(done) break;
    received+=value.length;

    let time=(performance.now()-start)/1000;
    let mbps=(received*8/1e6)/time;
    update(mbps,received/25000000*100);
  }
  return (received*8/1e6)/((performance.now()-start)/1000);
}

async function uploadTest(){
  const size=10*1024*1024;
  const data=new Uint8Array(size);
  const start=performance.now();
  await fetch("https://speed.cloudflare.com/__up",{
    method:"POST",
    body:data
  });
  return (size*8/1e6)/((performance.now()-start)/1000);
}

function update(mbps,progress){
  document.getElementById("speed").innerText = mbps.toFixed(2)+" Mbps";
  document.getElementById("down").innerText = mbps.toFixed(2)+" Mbps";
  document.getElementById("bar").style.width = progress+"%";
  rotateNeedle(mbps);
}

async function startTest(){
  const btn=document.getElementById("btn");
  btn.disabled=true;

  document.getElementById("bar").style.width="0%";
  document.getElementById("speed").innerText="Testing...";

  const ping=await pingTest();
  document.getElementById("ping").innerText=ping+" ms";

  const down=await downloadTest();
  document.getElementById("down").innerText=down.toFixed(2)+" Mbps";

  const up=await uploadTest();
  document.getElementById("up").innerText=up.toFixed(2)+" Mbps";

  btn.disabled=false;
}
</script>
</body>
</html>
